---
title: 模式-组合模式
date: 2018-06-14T16:35:00.000Z
tags:
  - 模式
  - 笔记
categories:
  - 模式
---

设计模式之组合模式

<!-- MORE -->

## 简介
> 将对象组合成树形结构，以表示“部分-整体”的层次结构。  
> 可以使得单个对象和组合对象的使用，具有一致性。

## 关键点
- 树形
- 部分 - 整体

## 实现方式
- 安全方式
- 透明方式 ： 组合动作公用，无法区分具体的Leaf、Composite

以下为 安全方式

## 类图
![](http://www.plantuml.com/plantuml/png/XP51Ji9058RtSueNLXWp5sYC8N7hqWiCTDGcROUqhsoGJK6Z3GXBOeonYGis4DaWMhXDfoqhhs2jwKYCwAvl_fTl_czQSv4vw5acEJ7Gv519evuSNIUJKAw65K8Q9dDTE38DRcCv2Aifx7o6DW7ORxEwYmvhO0UOhbTLkWSQj8IX_zXnk2LQ_DyrqUGEGrvLSOVO0ZaunjavQf04wsmUflFeVTMNiuVqzbbUpfFxc_Ikjud6sUmf2_lnygtiVypPQL5MOKjUNI0AImCvNCZfA0lyr7_DcV5oa7NNycgGl4GoUDnq9t6q8DiFu1h82-HEwRzCT-cfEjEnz2Tve_Bchpy0jF2dz10KbgWwGBqcfHVRsQVuByVg2mue5Tz2fCPjtRFC3m00)

```plantuml
@startuml
Title "组合模式"

class Client
class Component {
  +{abstract} add(Component) : void
  +{abstract} remove(Component) : void
  +{abstract} operate() : void
}
note right: 抽象类，实现共有的默认行为

class Leaf{
  +operate()
}
note bottom: 叶子节点，不能再添加部件

class Composite{
  +add(Component) : void
  +remove(Component) : void
  +operate() : void
}
note bottom: 存储子部件

Client -right--> Component
Composite -up--|> Component
Leaf -up--|> Component
Component <--o Composite

@enduml
```


## 实现
### PHP
#### 定义
```PHP7
abstract class Component
{
    abstract public function add(Component $component)
    : void;

    abstract public function remove(Component $component)
    : void;

    abstract public function operate(int $depth);

    // 一些能公用的代码
    protected $name = '';

    public function __construct($name)
    {
        $this->name = $name;
    }
}

class Leaf extends Component
{
    public function add(Component $component)
    : void
    {
        throw new \Exception('Cannot add to a leaf');
    }

    public function remove(Component $component)
    : void
    {
        throw new \Exception('Cannot remove from a leaf');
    }

    public function operate(int $depth)
    {
        echo str_pad('', $depth, '-'), $this->name, PHP_EOL;
    }
}

class Composite extends Component
{
    private $components = [];

    public function add(Component $component)
    : void
    {
        $this->components[ spl_object_id($component) ] = $component;
    }

    public function remove(Component $component)
    : void
    {
        unset($this->components[ spl_object_id($component) ]);
    }

    public function operate(int $depth)
    {
        echo str_pad('', $depth, '-'), $this->name, PHP_EOL;
        /** @var Component $component */
        foreach ($this->components as $component) {
            $component->operate($depth + 1);
        }
    }
}
```

#### 使用
```PHP7
$root = new Composite('root');
$root->add(new Leaf('root leaf a'));
$root->add(new Leaf('root leaf b'));

$compA = new Composite('composite a');
$compA->add(new Leaf('composite a leaf c'));
$compA->add(new Leaf('composite a leaf d'));
$compA->add(new Leaf('composite a leaf e'));

$root->add($compA);

$compAA = new Composite('composite aa');
$compAA->add(new Leaf('composite aa leaf f'));
$compAA->add(new Leaf('composite aa leaf g'));
$compAA->add(new Leaf('composite aa leaf h'));

$compA->add($compAA);

$root->operate(0);
```

#### 结果
```
root
-root leaf a
-root leaf b
-composite a
--composite a leaf c
--composite a leaf d
--composite a leaf e
--composite aa
---composite aa leaf f
---composite aa leaf g
---composite aa leaf h
```
